<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>2026 Health Plans – Total Cost Comparator</title>
  <style>
    :root { --bg:#0b1220; --panel:#121a2b; --ink:#e8eefc; --muted:#9fb0d0; --accent:#84a8ff; --ok:#4ade80; --warn:#f59e0b; --danger:#ef4444; }
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#0f172a);color:var(--ink);font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .wrap{max-width:1100px;margin-inline:auto;padding:24px}
    header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:18px}
    h1{font-size:20px;margin:0;font-weight:650;letter-spacing:.2px}
    .panel{background:var(--panel);border:1px solid #1f2a44;border-radius:16px;padding:16px;box-shadow:0 6px 18px rgba(0,0,0,.35)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    label{display:block;font-size:12px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;letter-spacing:.5px}
    select,button{background:#0e1628;color:var(--ink);border:1px solid #24314f;border-radius:10px;padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:#1a2a52;border-color:#2e4170}
    button.ghost{background:transparent}
    .pill{display:inline-flex;gap:8px;align-items:center;background:#0e1628;border:1px solid #24314f;border-radius:999px;padding:8px 12px}
    .grid{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px}
    .card{background:#0e1628;border:1px solid #24314f;border-radius:12px;padding:12px}
    .card b{display:block;font-size:18px}
    .chart-wrap{position:relative;height:600px}
    canvas{display:block;width:100%;height:100%}
    .legend{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .legend .item{display:flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid #223154;border-radius:999px;background:#0e1628}
    .swatch{width:18px;height:0;border-bottom:2px solid #789;border-radius:2px}
    .insights{margin-top:12px;display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px}
    .insights .card{font-size:13px}
    .data-table{overflow:auto; max-height:360px;}
    .data-table table{min-width:720px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px 8px;border-bottom:1px solid #223154}
    th{color:#c7d2fe;text-align:left}
    .muted{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>2026 Health Plans – Total Cost Comparator</h1>
      <div class="pill" title="Export current chart image">
        <button id="exportBtn" class="ghost">Export PNG</button>
      </div>
    </header>

    <section class="panel" aria-label="Controls">
      <div class="row">
        <div>
          <label>Coverage</label>
          <select id="tier">
            <option value="FAMILY" selected>Family</option>
            <option value="COUPLE">Couple</option>
            <option value="SINGLE">Single</option>
          </select>
        </div>
        <div>
          <label>Display</label>
          <div class="row" style="gap:8px">
            <label class="pill" style="gap:6px"><input id="toggleIntersections" type="checkbox" checked /> Show intersections</label>
            <label class="pill" style="gap:6px"><input id="toggleDelta" type="checkbox" /> Show HSA 60 − HSA 80</label>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px 0">Plan parameters (<span id="tierLabel">Family</span>)</h3>
      <div class="row" id="cards"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <div class="chart-wrap"><canvas id="chart"></canvas></div>
      <div class="legend" id="legend"></div>
      <div class="insights" id="insights"></div>
    </section>

    <section class="panel" style="margin-top:16px">
      <h3 style="margin:0 0 8px 0">Full data</h3>
      <div class="data-table" id="dataTable"></div>
    </section>

    <footer class="muted">Runs entirely in your browser using Chart.js. The curves are computed from fixed plan parameters; no uploads needed.</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script>
    const fmt = n => new Intl.NumberFormat().format(n);
    const $ = id => document.getElementById(id);

    // --- Plan parameters (baked-in) ---
    const X_POINTS = [0,250,500,750,1000,2000,3000,4000,5000,6000,7000,8000,9000,10000,11000,12000,13000,14000,15000,16000,17000,18000,19000,20000,21000,22000,23000,24000,25000,30000,35000,40000,45000,50000,60000,70000,80000];
    const PLANS = {
      FAMILY: {
        xPoints: X_POINTS,
        plans: {
          'PPO 90': { premiumYear:11800.8, coins:0.10, ded:0, oopMax:7000 },
          'PPO 70': { premiumYear: 4234.8, coins:0.30, ded:0, oopMax:9000 },
          'HSA 80': { premiumYear: 3368.4, employer:1700, coins:0.20, ded:3300, oopMax:9000 },
          'HSA 60': { premiumYear: 1533.6, employer:3050, coins:0.40, ded:6000, oopMax:15200 }
        }
      },
      COUPLE: {
        xPoints: X_POINTS,
        plans: {
          'PPO 90': { premiumYear:7459.2, coins:0.10, ded:0, oopMax:7000 },
          'PPO 70': { premiumYear:2739.6, coins:0.30, ded:0, oopMax:9000 },
          'HSA 80': { premiumYear:2838.0, employer:1700, coins:0.20, ded:3300, oopMax:9000 },
          'HSA 60': { premiumYear:1317.6, employer:3050, coins:0.40, ded:6000, oopMax:15200 }
        }
      },
      SINGLE: {
        xPoints: X_POINTS,
        plans: {
          'PPO 90': { premiumYear:3702.0, coins:0.10, ded:0, oopMax:3500 },
          'PPO 70': { premiumYear:1388.4, coins:0.30, ded:0, oopMax:5100 },
          'HSA 80': { premiumYear:1453.2, employer:1700, coins:0.20, ded:1700, oopMax:5100 },
          'HSA 60': { premiumYear:826.8, employer:3050, coins:0.40, ded:3050, oopMax:7600 }
        }
      }
    };

    function totalCost(plan, spend){
      if(plan.employer !== undefined){
        const base = plan.premiumYear - plan.employer; // may be negative
        const oopBeforeCap = spend <= plan.ded ? spend : plan.ded + (spend - plan.ded) * plan.coins;
        const oop = Math.min(oopBeforeCap, plan.oopMax);
        return base + oop;
      } else {
        const base = plan.premiumYear;
        const oop = Math.min(spend * plan.coins + plan.ded, plan.oopMax); // ded=0 for PPOs here
        return base + oop;
      }
    }

    function computeSeries(tier){
      const cfg = PLANS[tier];
      const xs = cfg.xPoints;
      const labels = Object.keys(cfg.plans);
      const series = {};
      labels.forEach(name => {
        const p = cfg.plans[name];
        series[name] = xs.map(x => Number(totalCost(p, x).toFixed(0)));
      });
      series['HSA 60 - HSA 80'] = xs.map((_,i) => Number((series['HSA 60'][i] - series['HSA 80'][i]).toFixed(0)));
      return { xs, series };
    }

    // Find intersection between two named series via linear interpolation
    function findIntersection(xs, sA, sB){
      const diffs = xs.map((x, i) => sA[i] - sB[i]);
      for(let i=0;i<xs.length-1;i++){
        const d1 = diffs[i], d2 = diffs[i+1];
        if(d1 === 0) return { x: xs[i], y: sA[i], i };
        if(d1 * d2 < 0){
          const x1 = xs[i], x2 = xs[i+1];
          const y1 = d1, y2 = d2; // crossing of diff line with y=0
          const t = (0 - y1) / (y2 - y1);
          const x = x1 + t * (x2 - x1);
          const y = sA[i] + t * (sA[i+1] - sA[i]);
          return { x, y, i };
        }
      }
      return null;
    }

    function buildDataTable(xs, series){
      const order = ['In-network spending','PPO 90','PPO 70','HSA 80','HSA 60','HSA 60 - HSA 80'];
      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      order.forEach(h => { const th = document.createElement('th'); th.textContent = h; trh.appendChild(th); });
      thead.appendChild(trh); tbl.appendChild(thead);
      const tb = document.createElement('tbody');
      for(let i=0;i<xs.length;i++){
        const tr = document.createElement('tr');
        const cells = [ '$'+fmt(xs[i]), series['PPO 90'][i], series['PPO 70'][i], series['HSA 80'][i], series['HSA 60'][i], series['HSA 60 - HSA 80'][i] ];
        cells.forEach((v,j)=>{
          const td = document.createElement('td');
          td.textContent = j===0 ? v : ('$'+fmt(v));
          tr.appendChild(td);
        });
        tb.appendChild(tr);
      }
      tbl.appendChild(tb);
      return tbl;
    }

    function renderCards(tier){
      const container = document.getElementById('cards');
      const tierLabel = document.getElementById('tierLabel');
      tierLabel.textContent = tier.charAt(0) + tier.slice(1).toLowerCase();
      container.innerHTML='';
      const order = ['PPO 90','PPO 70','HSA 80','HSA 60'];
      order.forEach(key => {
        const p = PLANS[tier].plans[key];
        const employer = p.employer || 0;
        const netPrem = p.premiumYear - employer;
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="muted">${key}</div>
          <table>
            <tr><td>Premium / year</td><td>$${fmt(p.premiumYear.toFixed(2))}</td></tr>
            ${p.employer!==undefined? `<tr><td>Employer contribution</td><td>$${fmt(p.employer.toFixed(2))}</td></tr>`:''}
            ${p.employer!==undefined? `<tr><td>Net premium − contrib</td><td>${netPrem<0?'-':''}$${fmt(Math.abs(netPrem).toFixed(2))}</td></tr>`:''}
            <tr><td>Deductible</td><td>$${fmt(p.ded)}</td></tr>
            <tr><td>Coinsurance</td><td>${Math.round(p.coins*100)}%</td></tr>
            <tr><td>OOP max</td><td>$${fmt(p.oopMax)}</td></tr>
          </table>`;
        container.appendChild(el);
      });
    }

    let chart;
    function draw(){
      const tier = $('tier').value;
      renderCards(tier);
      const { xs, series } = computeSeries(tier);

      const colors = { ppo90:'#3b82f6', ppo70:'#f59e0b', hsa80:'#22c55e', hsa60:'#60a5fa', delta:'#ef4444', cross:'#eab308' };
      const dsBase = [
        {key:'PPO 90', c:colors.ppo90, dash:[6,6]},
        {key:'PPO 70', c:colors.ppo70},
        {key:'HSA 80', c:colors.hsa80, dash:[6,6]},
        {key:'HSA 60', c:colors.hsa60}
      ];
      if($('toggleDelta').checked){ dsBase.push({key:'HSA 60 - HSA 80', c:colors.delta}); }
      const ds = dsBase.map(({key,c,dash}) => ({
        label:key,
        data: xs.map((x,i)=>({x, y: series[key][i]})),
        borderColor:c,
        borderWidth:2.5,
        borderDash:dash,
        pointRadius:1.4,
        tension:.2,
        fill:false
      }));

      // --- Compute intersections (optional) ---
      const crosses = [];
      if($('toggleIntersections').checked){
        const pairs = [
          ['HSA 60','HSA 80'],
          ['HSA 60','PPO 70'],
          ['HSA 60','PPO 90'],
          ['PPO 70','PPO 90'],
          ['PPO 70','HSA 80'],
          ['PPO 90','HSA 80']
        ];
        for(const [a,b] of pairs){
          const hit = findIntersection(xs, series[a], series[b]);
          if(hit){
            crosses.push({a,b,x:hit.x,y:hit.y});
            const yMin = Math.min(...Object.values(series).map(arr => Math.min(...arr)));
            const yMax = Math.max(...Object.values(series).map(arr => Math.max(...arr)));
            ds.push({
              label:`× ${a} vs ${b}`,
              data:[{x:hit.x,y:yMin},{x:hit.x,y:yMax}],
              borderColor:colors.cross,
              borderDash:[2,6],
              borderWidth:1.5,
              pointRadius:0,
              fill:false,
            });
            ds.push({
              type:'scatter',
              label:`• ${a}∩${b}`,
              data:[{x:hit.x,y:hit.y}],
              pointRadius:4,
              pointHoverRadius:6,
              pointBackgroundColor:colors.cross,
              borderColor:colors.cross
            });
          }
        }
      }

      const ctx = $('chart').getContext('2d');
      if(chart) chart.destroy();
      chart = new Chart(ctx, {
        type:'line',
        data:{ datasets: ds },
        options:{
          resizeDelay: 200,
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'nearest',intersect:false},
          scales:{
            x:{ type:'linear', title:{display:true,text:'In-network spending ($)'}, grid:{ color:'rgba(255,255,255,.06)'} },
            y:{ title:{display:true,text:'Total cost ($)'}, grid:{ color:'rgba(255,255,255,.06)'}, ticks:{ callback:v=>'$'+fmt(v) } }
          },
          plugins:{
            legend:{ display:true, labels:{ color:'#c7d2fe' } },
            tooltip:{
              callbacks:{
                label:(ctx)=>{
                  if(ctx.dataset.label.startsWith('• ')){
                    return `${ctx.dataset.label.replace('• ','')} at $${fmt(ctx.parsed.x)} → $${fmt(ctx.parsed.y)}`;
                  }
                  return `${ctx.dataset.label}: $${fmt(ctx.parsed.y)}`
                }
              }
            },
            title:{ display:true, text:`Total cost by in‑network spending — ${tier}` }
          },
          elements:{ line:{ cubicInterpolationMode:'monotone' } }
        }
      });

      // Legend tokens
      const legend = $('legend'); legend.innerHTML = '';
      for(const d of chart.data.datasets.filter(d=>!d.label.startsWith('×') && !d.label.startsWith('• '))){
        const item = document.createElement('div'); item.className='item';
        const sw = document.createElement('div'); sw.className='swatch'; sw.style.borderBottom = (d.borderDash? '2px dashed '+d.borderColor : '2px solid '+d.borderColor);
        const txt = document.createElement('span'); txt.textContent = d.label;
        item.appendChild(sw); item.appendChild(txt); legend.appendChild(item);
      }

      // Insights list with numeric intersections
      const ins = $('insights'); ins.innerHTML = '';
      if($('toggleIntersections').checked && crosses.length){
        const byPair = document.createElement('div'); byPair.className='card';
        let html = '<b>Intersections</b><div style="margin-top:6px;display:flex;flex-direction:column;gap:4px">';
        for(const c of crosses){
          html += `<div><span class="muted">${c.a}</span> crosses <span class="muted">${c.b}</span> at <b>$${fmt(Math.round(c.x))}</b> (cost ≈ $${fmt(Math.round(c.y))})</div>`;
        }
        html += '</div>';
        byPair.innerHTML = html; ins.appendChild(byPair);
      }

      // Render data table
      const dt = $('dataTable');
      dt.innerHTML = '';
      dt.appendChild(buildDataTable(xs, series));
    }

    // Event handlers (single registration)
    $('tier').addEventListener('change', draw);
    $('toggleIntersections').addEventListener('change', draw);
    $('toggleDelta').addEventListener('change', draw);
    $('exportBtn').addEventListener('click', () => {
      if(!chart){ draw(); }
      const tier = $('tier').value;
      const canvas = $('chart');
      // Create a white-backed copy to avoid transparent PNG background
      const tmp = document.createElement('canvas');
      tmp.width = canvas.width;
      tmp.height = canvas.height;
      const ctx2 = tmp.getContext('2d');
      ctx2.fillStyle = '#ffffff';
      ctx2.fillRect(0,0,tmp.width,tmp.height);
      ctx2.drawImage(canvas,0,0);
      const url = tmp.toDataURL('image/png');
      const a = document.createElement('a');
      a.href = url;
      a.download = `health-plan-comparison-${tier.toLowerCase()}.png`;
      a.click();
    });

    // --- simple console self-tests to guard regressions ---
    (function runTests(){
      const almostEq = (desc, a, b, tol=2) => { // dollars tolerance
        if(Math.abs(a-b) > tol) console.error('TEST FAIL:', desc, a, '!=', b, '+/-', tol); else console.log('TEST OK:', desc);
      };
      const assertEq = (desc, a, b) => { if(a !== b) console.error('TEST FAIL:', desc, a, '!==', b); else console.log('TEST OK:', desc); };

      // FAMILY deltas
      let {xs, series} = computeSeries('FAMILY');
      const idx = x => xs.indexOf(x);
      assertEq('FAMILY delta @0', series['HSA 60 - HSA 80'][idx(0)], -3185);
      assertEq('FAMILY delta @4000', series['HSA 60 - HSA 80'][idx(4000)], -2625);
      assertEq('FAMILY delta @8000', series['HSA 60 - HSA 80'][idx(8000)], -625);
      assertEq('FAMILY delta @12000', series['HSA 60 - HSA 80'][idx(12000)], 175);
      assertEq('FAMILY delta @30000', series['HSA 60 - HSA 80'][idx(30000)], 3375);
      // FAMILY intersections (approx.)
      const i1 = findIntersection(xs, series['HSA 60'], series['HSA 80']);
      almostEq('FAMILY HSA60 vs HSA80 ~ $11,125', Math.round(i1.x), 11125, 5);

      // COUPLE deltas
      ({xs, series} = computeSeries('COUPLE'));
      const idx2 = x => xs.indexOf(x);
      assertEq('COUPLE delta @0', series['HSA 60 - HSA 80'][idx2(0)], -2870);
      assertEq('COUPLE delta @4000', series['HSA 60 - HSA 80'][idx2(4000)], -2310);
      assertEq('COUPLE delta @8000', series['HSA 60 - HSA 80'][idx2(8000)], -310);
      assertEq('COUPLE delta @10000', series['HSA 60 - HSA 80'][idx2(10000)], 90);
      assertEq('COUPLE delta @30000', series['HSA 60 - HSA 80'][idx2(30000)], 3690);
      assertEq('COUPLE delta @35000', series['HSA 60 - HSA 80'][idx2(35000)], 3330);
      // COUPLE intersection (approx.)
      const i2 = findIntersection(xs, series['HSA 60'], series['HSA 80']);
      almostEq('COUPLE HSA60 vs HSA80 ~ $9,550', Math.round(i2.x), 9550, 5);

      // SINGLE deltas
      ({xs, series} = computeSeries('SINGLE'));
      const idx3 = x => xs.indexOf(x);
      assertEq('SINGLE delta @0', series['HSA 60 - HSA 80'][idx3(0)], -1976);
      assertEq('SINGLE delta @2000', series['HSA 60 - HSA 80'][idx3(2000)], -1736);
      assertEq('SINGLE delta @8000', series['HSA 60 - HSA 80'][idx3(8000)], 94);
      assertEq('SINGLE delta @10000', series['HSA 60 - HSA 80'][idx3(10000)], 494);
      assertEq('SINGLE delta @25000', series['HSA 60 - HSA 80'][idx3(25000)], 524);
      // SINGLE intersection (approx.)
      const i3 = findIntersection(xs, series['HSA 60'], series['HSA 80']);
      almostEq('SINGLE HSA60 vs HSA80 ~ $7,550', Math.round(i3.x), 7550, 5);

      // Generic tests: shape & monotonicity
      const tiers = ['FAMILY','COUPLE','SINGLE'];
      const labels = ['PPO 90','PPO 70','HSA 80','HSA 60'];
      for(const t of tiers){
        const {xs:sx, series:sr} = computeSeries(t);
        for(const lab of labels){
          assertEq(`${t} ${lab} length`, sr[lab].length, sx.length);
          // non-decreasing total costs
          let ok = true;
          for(let i=0;i<sr[lab].length-1;i++){ if(sr[lab][i+1] < sr[lab][i]){ ok=false; break; } }
          if(!ok) console.error('TEST FAIL: monotonic', t, lab); else console.log('TEST OK: monotonic', t, lab);
        }
      }

      // UI-toggle tests (non-destructive)
      const prevDelta = $('toggleDelta').checked;
      const prevInter = $('toggleIntersections').checked;
      $('toggleDelta').checked = false; $('toggleIntersections').checked = false;
      draw();
      const labelsOff = chart.data.datasets.map(d=>d.label);
      if(labelsOff.includes('HSA 60 - HSA 80')) console.error('TEST FAIL: delta visible when toggle off'); else console.log('TEST OK: delta hidden');
      if(labelsOff.some(l=>l.startsWith('×')||l.startsWith('• '))) console.error('TEST FAIL: intersections visible when toggle off'); else console.log('TEST OK: intersections hidden');
      // restore
      $('toggleDelta').checked = prevDelta; $('toggleIntersections').checked = prevInter;
    })();

    // initial render
    draw();
  </script>
</body>
</html>
